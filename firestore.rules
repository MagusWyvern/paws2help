rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(data) {
      return isSignedIn()
        && data.keys().hasAll(['uid'])
        && data.uid == request.auth.uid;
    }

    function isConversationParticipant(data) {
      return isSignedIn()
        && data.keys().hasAll(['participantIds'])
        && data.participantIds is list
        && request.auth.uid in data.participantIds;
    }

    match /pet-coords/{docId} {
      allow read: if true;
      allow create: if isSignedIn()
        && request.resource.data.uid == request.auth.uid;
      allow update, delete: if isOwner(resource.data);
    }

    match /stray-reports/{docId} {
      allow create: if isSignedIn()
        && request.resource.data.uid == request.auth.uid;
      allow read, update, delete: if isOwner(resource.data);
    }

    match /conversations/{conversationId} {
      allow create: if isSignedIn()
        && request.resource.data.keys().hasAll([
          'listingId',
          'listingAddress',
          'listingOwnerUid',
          'listingOwnerName',
          'participantIds',
          'createdBy',
          'createdAt',
          'updatedAt',
          'lastMessageText',
          'lastMessageSenderId'
        ])
        && request.resource.data.keys().hasOnly([
          'listingId',
          'listingAddress',
          'listingOwnerUid',
          'listingOwnerName',
          'participantIds',
          'createdBy',
          'createdAt',
          'updatedAt',
          'lastMessageText',
          'lastMessageSenderId'
        ])
        && request.resource.data.participantIds is list
        && request.resource.data.participantIds.size() == 2
        && request.resource.data.participantIds[0] is string
        && request.resource.data.participantIds[1] is string
        && request.resource.data.participantIds[0] != request.resource.data.participantIds[1]
        && request.auth.uid in request.resource.data.participantIds
        && request.resource.data.listingOwnerUid in request.resource.data.participantIds
        && request.resource.data.createdBy == request.auth.uid
        && request.resource.data.listingId is string
        && request.resource.data.listingAddress is string
        && request.resource.data.listingOwnerUid is string
        && request.resource.data.listingOwnerName is string
        && request.resource.data.lastMessageText is string
        && request.resource.data.lastMessageText.size() <= 1000
        && request.resource.data.lastMessageSenderId is string;

      allow read: if isConversationParticipant(resource.data);

      allow update: if isConversationParticipant(resource.data)
        && request.resource.data.keys().hasOnly([
          'listingId',
          'listingAddress',
          'listingOwnerUid',
          'listingOwnerName',
          'participantIds',
          'createdBy',
          'createdAt',
          'updatedAt',
          'lastMessageText',
          'lastMessageSenderId'
        ])
        && request.resource.data.participantIds == resource.data.participantIds
        && request.resource.data.listingId == resource.data.listingId
        && request.resource.data.listingAddress == resource.data.listingAddress
        && request.resource.data.createdBy == resource.data.createdBy
        && request.resource.data.createdAt == resource.data.createdAt
        && request.resource.data.listingOwnerUid == resource.data.listingOwnerUid
        && request.resource.data.listingOwnerName == resource.data.listingOwnerName
        && request.resource.data.updatedAt is timestamp
        && request.resource.data.lastMessageText is string
        && request.resource.data.lastMessageText.size() <= 1000
        && request.resource.data.lastMessageSenderId is string
        && request.resource.data.lastMessageSenderId in resource.data.participantIds
        && request.resource.data.lastMessageSenderId == request.auth.uid;

      allow delete: if false;
    }

    match /conversations/{conversationId}/messages/{messageId} {
      allow read: if isConversationParticipant(
        get(/databases/$(database)/documents/conversations/$(conversationId)).data
      );

      allow create: if isConversationParticipant(
          get(/databases/$(database)/documents/conversations/$(conversationId)).data
        )
        && request.resource.data.keys().hasAll([
          'senderId',
          'senderName',
          'text',
          'createdAt'
        ])
        && request.resource.data.keys().hasOnly([
          'senderId',
          'senderName',
          'text',
          'createdAt'
        ])
        && request.resource.data.senderId == request.auth.uid
        && request.resource.data.senderName is string
        && request.resource.data.senderName.size() <= 120
        && request.resource.data.text is string
        && request.resource.data.text.size() > 0
        && request.resource.data.text.size() <= 1000;

      allow update, delete: if false;
    }
  }
}
